---

apiVersion: kappctrl.k14s.io/v1alpha1
kind: App
metadata:
  name: {{ .Values.namespace }}
  namespace: {{ .Values.namespace }}
  annotations:
    kapp.k14s.io/change-rule.create-order: "upsert after upserting rbac"
    kapp.k14s.io/change-rule.delete-order: "delete before deleting rbac"
spec:
  serviceAccountName: {{ .Values.namespace }}-sa
  fetch:
  {{- if .Values.git.enabled }}
    - git:
      url: {{ .Values.git.repo }}
      ref: {{ .Values.git.branch }}
      subPath: {{ .Values.git.path }}
    {{- if .Values.git.secretRef }}
      secretRef:
        name: {{ .Values.git.secretRef.name }}
        namespace: {{ .Values.git.secretRef.namespace }}
    {{- end }}
  {{- end }}

  template:
    - ytt: {}

  deploy:
    - kapp: {}
